name: Invite Student on Comment

on:
  issue_comment:
    types: [created]

jobs:
  invite:
    if: contains(github.event.comment.body, '/가입요청') && github.event.comment.user.type != 'Bot' && github.event.issue.number == 1
    runs-on: ubuntu-latest
    steps:
      - name: Invite user to organization and team
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.ORG_ADMIN_TOKEN }}
          script: |
            const org = context.repo.owner;
            const username = context.payload.comment.user.login;
            const team_slug = 'All-AI-Students';

            console.log(`Processing invitation for user: ${username}`);

            try {
              const teamResponse = await github.rest.teams.getByName({
                org: org,
                team_slug: team_slug
              });
              const team_id = teamResponse.data.id;
              console.log(`Found team ID for ${team_slug}: ${team_id}`);

              try {
                await github.rest.orgs.createInvitation({
                  org: org,
                  invitee_id: context.payload.comment.user.id,
                  team_ids: [team_id],
                  role: 'direct_member'
                });
                console.log(`Invitation sent to ${username} with team ${team_slug}.`);
                
                await github.rest.reactions.createForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id,
                  content: 'rocket'
                });

              } catch (inviteError) {
                if (inviteError.status === 422) {
                  console.log(`User ${username} is likely already a member. Trying to add to team directly...`);
                  
                  await github.rest.teams.addOrUpdateMembershipForUserInOrg({
                    org: org,
                    team_slug: team_slug,
                    username: username,
                    role: 'member'
                  });
                  console.log(`User ${username} added to team ${team_slug}.`);
                  
                  await github.rest.reactions.createForIssueComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: context.payload.comment.id,
                    content: 'eyes'
                  });
                } else {
                  throw inviteError;
                }
              }

            } catch (error) {
              console.error(error);
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'confused'
              });
              
              /*
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `@${username} 처리 중 오류가 발생했습니다. 관리자에게 문의하세요.`
              });
              */
            }
